<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dina växter</title>

  <!-- CSS + typsnitt -->
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Italiana&display=swap" rel="stylesheet">

  <!-- MQTT & Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
<div class="app-container"> 

  <h1>Cordyline</h1>
  <img src="Bilder/cordyline.png" class="plantInliningCORDYLINE" alt="Cordyline">

  <h2>Fuktighetsnivå</h2>
  <div class="value" id="humidity">--%</div>

  <div>
    <canvas id="myChart"></canvas>
  </div>

<script>
/* ===============================
   1️⃣ MQTT – TA EMOT DATA
================================ */

const host = "ws://77.42.37.48:9001";
const client = mqtt.connect(host);

client.on("connect", () => {
  console.log("Connected to MQTT broker");
  client.subscribe("grupp3/soil/humidity");
});

/* ===============================
   2️⃣ CHART.JS – INITIERING
================================ */

const labels = [];
const moistureData = [];
const recommendedData = [];

const ctx = document.getElementById("myChart");

const myChart = new Chart(ctx, {
  type: "line",
  data: {
    labels: labels,
    datasets: [
      {
        label: "Växtens fuktighet",
        data: moistureData,
        borderWidth: 2,
        fill: true,
        tension: 0.4
      },
      {
        label: "Rekommenderad fuktighet",
        data: recommendedData,
        borderDash: [5, 5],
        pointRadius: 0
      }
    ]
  },
  options: {
    scales: {
      y: {
        min: 0,
        max: 100,
        ticks: {
          callback: value => value + " %"
        }
      }
    }
  }
});

/* ===============================
   3️⃣ KOPPLING: MQTT → CHART
================================ */

client.on("message", (topic, message) => {
  const value = Number(message.toString());

  // Uppdatera text
  document.getElementById("humidity").innerText = value + "%";

  // Lägg till data i charten
  const time = new Date().toLocaleTimeString();
  labels.push(time);
  moistureData.push(value);
  recommendedData.push(60);

  // Begränsa historik
  if (labels.length > 30) {
    labels.shift();
    moistureData.shift();
    recommendedData.shift();
  }

  myChart.update();
});
</script>

</div>
</body>
</html>
